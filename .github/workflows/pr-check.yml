name: PR ì²´í¬

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint-and-analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: JDK 21 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Gradle ìºì‹œ
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Gradle ê¶Œí•œ ì„¤ì •
      run: chmod +x gradlew
    
    - name: ktlint ìŠ¤íƒ€ì¼ ì²´í¬
      id: ktlint
      run: |
        ./gradlew ktlintCheck > ktlint-output.txt 2>&1 || true
        if grep -q "Task :ktlintCheck FAILED" ktlint-output.txt; then
          echo "ktlint_failed=true" >> $GITHUB_OUTPUT
          cat ktlint-output.txt
          exit 1
        fi
    
    - name: detekt ì •ì  ë¶„ì„
      id: detekt
      run: |
        ./gradlew detekt > detekt-output.txt 2>&1 || true
        if grep -q "Task :detekt FAILED" detekt-output.txt; then
          echo "detekt_failed=true" >> $GITHUB_OUTPUT
          cat detekt-output.txt
          exit 1
        fi
    
    - name: ì»´íŒŒì¼ ì²´í¬
      run: ./gradlew compileKotlin compileTestKotlin
    
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: ./gradlew test
      env:
        SPRING_PROFILES_ACTIVE: test
        OPENROUTER_API_KEY: test-api-key
        JWT_SECRET: test-jwt-secret-key-for-jwt-authentication-that-is-at-least-256-bits-long-for-security-requirements-2025
    
    - name: PR ì½”ë©˜íŠ¸ - ì„±ê³µ
      if: success()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = `## âœ… PR ì²´í¬ ê²°ê³¼: ì„±ê³µ!
          
          ### ê²€ì‚¬ í•­ëª©
          - âœ… **ktlint** ìŠ¤íƒ€ì¼ ì²´í¬ í†µê³¼
          - âœ… **detekt** ì •ì  ë¶„ì„ í†µê³¼
          - âœ… ì»´íŒŒì¼ ì„±ê³µ
          - âœ… í…ŒìŠ¤íŠ¸ í†µê³¼
          
          ëª¨ë“  ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‘`;
          
          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
            body: message,
            event: 'COMMENT'
          })
    
    - name: PR ì½”ë©˜íŠ¸ - ktlint ì‹¤íŒ¨
      if: steps.ktlint.outputs.ktlint_failed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = `## âŒ ktlint ìŠ¤íƒ€ì¼ ì²´í¬ ì‹¤íŒ¨
          
          ì½”ë“œ ìŠ¤íƒ€ì¼ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### ìˆ˜ì • ë°©ë²•
          \`\`\`bash
          ./gradlew ktlintFormat
          \`\`\`
          
          ìœ„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ìë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
          
          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
            body: message,
            event: 'COMMENT'
          })
    
    - name: PR ì½”ë©˜íŠ¸ - detekt ì‹¤íŒ¨
      if: steps.detekt.outputs.detekt_failed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = `## âŒ detekt ì •ì  ë¶„ì„ ì‹¤íŒ¨
          
          ì½”ë“œ í’ˆì§ˆ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### í™•ì¸ ë°©ë²•
          \`\`\`bash
          ./gradlew detekt
          \`\`\`
          
          ìœ„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.
          ë¦¬í¬íŠ¸ëŠ” \`build/reports/detekt/detekt.html\`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
          
          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
            body: message,
            event: 'COMMENT'
          })